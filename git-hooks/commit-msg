#!/bin/bash
set -euo pipefail

messagePrefix='^(feat|fix|docs|refactor|chore|test): '

messageFile="$1"

branch=""
if [[ -d .git/rebase-merge ]] && [[ -f .git/rebase-merge/head-name ]]; then
  branch=$(sed 's|refs/heads/||' .git/rebase-merge/head-name)
else
  # Fallback to symbolic-ref; if detached HEAD, this may fail
  branch=$(git symbolic-ref --short -q HEAD || true)
fi

# If we couldn't determine a branch (e.g., detached HEAD), do nothing
if [[ -z "${branch}" || "${branch}" == "HEAD" ]]; then
  exit 0
fi

read -r firstLine < "$messageFile"

if [[ $branch == "main" || $branch == "master" ]]; then
  if ! [[ $firstLine =~ $messagePrefix ]]; then
    echo "Error in commit-msg-hook: Invalid commit prefix, must match regex '$messagePrefix'"
    echo $firstLine
    exit 1
  fi
  exit 0
fi

# Skip merge commits (Git generates a default message starting with "Merge ")
if [[ "$firstLine" == Merge* ]]; then
  exit 0
fi

required_prefix="${branch}: "

# If already correctly prefixed, we're done
if [[ "$firstLine" == "$required_prefix"* ]]; then
  exit 0
fi

# If it starts with the branch but with another separator, normalize to ": "
if [[ "$firstLine" == "${branch} "* ]] || [[ "$firstLine" == "${branch} - "* ]] || [[ "$firstLine" == "${branch}-"* ]]; then
  # Remove the branch and any separators following it, then re-add normalized prefix
  remainder=${firstLine#${branch}}
  remainder=${remainder#[: -]}
  # Trim a single leading space, colon, or dash if present
  remainder=${remainder# }
  remainder=${remainder#: }
  remainder=${remainder#- }
  new_firstline="${required_prefix}${remainder}"
else
  # Prepend the required prefix
  new_firstline="${required_prefix}${firstLine}"
fi

# Reconstruct the message file with the new first line
# Preserve the rest of the content as-is
rest=$(tail -n +2 "$messageFile" || true)
{
  printf "%s\n" "$new_firstline"
  # Only print rest if there is any
  if [[ -n "${rest}" ]]; then
    printf "%s\n" "$rest"
  fi
} > "$messageFile"

# OK
exit 0